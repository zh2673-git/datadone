# 多源数据分析系统

## 📋 项目概述

多源数据分析系统是一个专业的数据分析工具，专门用于处理和分析银行、微信、支付宝、话单等多种数据源。系统采用模块化设计，提供全面的数据分析功能，包括频率分析、时间模式分析、金额分析、综合交叉分析等，并支持Excel和Word格式的专业报告导出。

## 🏗️ 系统架构

```
多源数据分析系统/
├── src/                          # 源代码目录
│   ├── base/                     # 基础模块
│   │   ├── base_analyzer.py      # 分析器基类
│   │   └── base_model.py         # 数据模型基类
│   ├── datasource/               # 数据源模块
│   │   ├── bank_model.py         # 银行数据模型
│   │   ├── call_model.py         # 话单数据模型
│   │   └── payment/              # 支付数据子模块
│   │       ├── wechat_model.py   # 微信数据模型
│   │       └── alipay_model.py   # 支付宝数据模型
│   ├── analysis/                 # 分析模块
│   │   ├── bank_analyzer.py      # 银行数据分析器
│   │   ├── call_analyzer.py      # 话单数据分析器
│   │   ├── comprehensive_analyzer.py  # 综合分析器
│   │   └── payment/              # 支付分析子模块
│   │       ├── wechat_analyzer.py    # 微信数据分析器
│   │       └── alipay_analyzer.py    # 支付宝数据分析器
│   ├── export/                   # 导出模块
│   │   ├── excel_exporter.py     # Excel导出器
│   │   └── word_exporter.py      # Word导出器
│   ├── interface/                # 用户界面模块
│   │   ├── cli_interface.py      # 命令行界面
│   │   ├── cli_interface_data.py # 数据管理界面
│   │   └── cli_interface_export.py # 导出界面
│   └── utils/                    # 工具模块
│       ├── config.py             # 配置管理
│       ├── exceptions.py         # 异常定义
│       ├── advanced_analysis.py  # 高级分析工具
│       └── cash_recognition.py   # 存取现识别工具
├── config.json                   # 配置文件
├── main.py                       # 主程序入口
└── README.md                     # 项目说明文档
```

## 🔧 核心功能模块

### 数据源模块 (datasource/)
- **银行数据模型**: 处理银行交易数据，支持存取现识别、收支分类
- **话单数据模型**: 处理通话记录数据，支持通话时长、频率统计
- **微信数据模型**: 处理微信支付数据，支持转账、红包等交易类型
- **支付宝数据模型**: 处理支付宝交易数据，支持多种支付场景

### 分析模块 (analysis/)
- **银行分析器**: 提供银行数据的频率分析、金额分析、时间模式分析
- **话单分析器**: 提供通话频率分析、时间分布分析、联系人分析
- **微信分析器**: 提供微信交易分析、转账模式分析
- **支付宝分析器**: 提供支付宝交易分析、消费模式分析
- **综合分析器**: 跨数据源的关联分析、交叉验证分析

### 导出模块 (export/)
- **Excel导出器**: 生成结构化的Excel分析报告，包含8个核心工作表
- **Word导出器**: 生成专业的Word分析报告，支持按人员分组显示

### 工具模块 (utils/)
- **配置管理**: 统一的配置文件管理，支持字段映射和参数配置
- **高级分析工具**: 提供时间模式、金额模式、异常检测等高级分析功能
- **存取现识别**: 智能识别银行数据中的存取现交易

## 📊 分析功能特性

### 基础分析
- **频率分析**: 统计交易频率、通话频率，识别高频联系人
- **金额分析**: 分析交易金额分布、大额交易识别
- **时间分析**: 分析交易时间模式、工作日/周末分布
- **存取现识别**: 智能识别银行数据中的存取现交易

### 高级分析
- **行为模式分析**: 识别用户的交易习惯和行为特征
- **异常检测**: 检测异常交易、可疑行为模式
- **关联分析**: 分析不同数据源之间的关联关系

### 综合分析
- **跨平台分析**: 整合银行、微信、支付宝数据进行综合分析
- **交叉验证**: 通过多数据源验证交易的真实性和一致性
- **关系网络**: 构建基于交易和通话的关系网络
- **多基准分析**: 支持以话单、账单类或单个平台为基准的交叉分析

## 📈 报告功能

### Excel报告
1. **分析汇总表** - 各平台汇总数据概览
2. **账单类频率表** - 银行、微信、支付宝频率分析
3. **话单类频率表** - 通话记录频率分析
4. **综合分析表** - 全方位多基准交叉分析结果（包含对方详细信息，支持传统交叉分析+各平台基准分析）
5. **平台原始数据** - 各平台的原始数据展示
6. **高级分析表** - 高级分析结果汇总（含通俗易懂的指标说明）

### Word报告
- **个人详细分析**: 按人员分组的详细分析报告
- **综合交叉分析**: 按本方姓名排序的关联分析，展示不同数据源间的关联关系
- **重点收支分析**: 重要交易和收支模式分析
- **专业图表**: 包含统计图表和可视化分析

## 🚀 使用方式

### 命令行启动
```bash
python main.py
```

### 主要操作流程
1. **数据加载**: 选择并加载银行、微信、支付宝、话单数据文件
2. **执行分析**: 对加载的数据执行全面分析或专项分析
3. **导出报告**: 生成Excel或Word格式的分析报告

## ⚙️ 配置说明

系统使用`config.json`文件进行配置管理，支持：
- **字段映射**: 自定义各数据源的字段名称映射
- **分析参数**: 配置分析算法的参数和阈值
- **导出设置**: 配置报告导出的格式和样式

## 🔄 最新更新内容

### 综合分析交叉比对逻辑修复 (v0.0.13)
- **跨数据源对手信息显示**: 修复综合分析sheet中的交叉比对逻辑问题
  - 问题修复：当A只有账单、B只有话单时，B的对手信息现在能正确显示在综合分析中
  - 跨人员匹配：支持基于对方姓名的跨人员匹配，DEF话单中的对手信息可以匹配到ABC账单中的相同对手
  - 智能匹配：话单数据作为对手信息的"资源库"，为账单数据补充单位信息和交易数据
  - 性能优化：避免创建过多无意义的数据组合，确保Excel表格大小在合理范围内
- **数据完整性保障**: 确保综合分析表能完整展示所有导入数据的对手信息
  - 双重匹配：先尝试完全匹配（本方姓名+对方姓名），再尝试跨人员匹配（仅对方姓名）
  - 数据聚合：按对方姓名聚合其他数据源的信息，确保跨人员匹配的准确性
  - 全局映射：通过全局联系人映射补充缺失的单位信息
- **字段名称兼容性修复**: 修复话单数据中通话时长字段名称不一致的问题
  - 兼容处理：同时支持`通话总时长(分钟)`和`通话时长`两种列名
  - 智能检测：自动检测实际存在的列名并进行相应处理
  - 错误修复：解决综合分析中"Column(s) ['通话时长'] do not exist"的错误

### 综合分析功能增强
- **全面多基准分析**: 大幅增强综合分析功能，支持全方位的交叉分析基准
  - 传统分析：提供"以话单为基准"和"以账单类为基准"的交叉分析（当有话单数据时）
  - 平台分析：同时提供"以银行为基准"、"以微信为基准"、"以支付宝为基准"的交叉分析
  - 智能适配：各平台基准分析能与其他所有数据源（包括话单）进行交叉分析
- **数据源全覆盖**: 无论数据组合如何，都能生成有价值的综合分析表
  - 有话单+账单：生成传统交叉分析 + 各平台基准分析
  - 只有账单：生成各平台间的交叉分析
  - 单一平台：提示无法进行交叉分析
- **分析维度扩展**: 在综合分析表中清晰标识每组分析的基准类型，支持多维度对比

### Word报告分析功能增强
- **重复最多金额扩展**: 将所有"重复最多的金额"从显示1个扩展为显示排名前3个
- **单笔主要金额优化**: 避免重复列举同一对象的金额，优先显示不同对象的前3个金额
- **特殊分析结构重组**: 将"特殊金额"改名为"特殊分析"，包含：
  - (1)特殊金额：原有的特殊金额分析内容
  - (2)特殊日期：新增特殊日期分析，显示交易总额最多的前3个特殊日期
- **整数金额分析**: 新增整数金额分析功能
  - 银行：分析≥1000元的整数金额，显示出现次数最多的前3个
  - 微信/支付宝：分析≥200元的整数金额，显示出现次数最多的前3个

### Excel报告功能完善
- **综合分析表字段增强**: 在"综合分析"表中新增"对方单位名称"和"对方职务"字段，放置在"对方号码"字段后面
- **综合分析表数据修复**: 全面修复各分析基准的字段数据显示问题：
  - 传统分析基准（以话单/账单类为基准）：新增各平台独立字段显示
  - 平台分析基准（以具体平台为基准）：新增"平台"字段显示其他平台信息
  - 数据来源字段：正确显示基准平台的数据来源
  - 平台金额分布：准确显示其他平台的金额分布详情
  - 各平台独立字段：如"银行_收入总额"、"微信_支出总额"、"支付宝_交易次数"等
- **分析类型字段扩展**: 在银行/微信/支付宝分析原始表的"分析类型"字段中新增"整数金额"分类
- **话单类频率表优化**: 确保"对方单位名称"和"对方职务"字段正确显示在对方姓名后面

### 配置文件增强
- **整数金额阈值配置**: 新增integer_amount配置项
  - bank_threshold: 1000 (银行整数金额阈值)
  - wechat_threshold: 200 (微信整数金额阈值)
  - alipay_threshold: 200 (支付宝整数金额阈值)

### 技术架构优化
- **分析器功能扩展**: 在银行和支付分析器中新增整数金额分析方法
- **Word导出器重构**: 优化特殊分析生成逻辑，支持特殊金额和特殊日期的组合显示
- **Excel导出器增强**: 完善分析类型字段的分类逻辑，支持更细粒度的数据分类
- **配置管理优化**: 通过配置文件灵活控制整数金额阈值，便于不同场景的定制化需求

### 综合分析跨人员匹配逻辑修复 (v0.0.14)
- **严格匹配原则**: 修复综合分析中的跨人员关联错误问题
  - **问题修复**: 当A与B有通话但无账单关系，而C与B有账单关系时，系统不再错误地将C与B的账单关系关联到A与B的通话记录
  - **匹配逻辑**: 移除基于"对方姓名"的跨人员匹配，仅保留"本方姓名+对方姓名"的完全匹配
  - **数据准确性**: 确保每个通话记录只关联对应本人的账单数据，避免不同人员间的数据混淆
- **代码优化**: 
  - **Excel导出器**: 在`_cross_analyze_with_call_base`方法中移除跨人员匹配逻辑
  - **综合分析器**: 在`merge_analysis_results`方法中移除跨人员匹配逻辑
  - **平台分析**: 各平台基准分析同样采用严格匹配原则，确保数据关联的准确性
- **用户体验**: 提高综合分析报告的数据准确性和可信度，避免误导性的关联结果